name: Publish Docker Image
on:
    release:
        types: [published]
jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout repository
          uses: actions/checkout@v2
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1
        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        - name: Log in to Quay.io
          uses: docker/login-action@v1
          with:
            registry: quay.io
            username: ${{ secrets.QUAY_USERNAME }}
            password: ${{ secrets.QUAY_PASSWORD }}
        - name: Check if dev branch
          if: ${{ contains(github.ref, 'dev') }}
          id: check_dev_branch
          run: echo "Dev branch"
          env:
            IMG_PREFIX: "dev-"
        - name: Check if main branch
          if: ${{ contains(github.ref, 'main') }}
          id: check_main_branch
          run: echo "Main branch"
          env:
            IMG_PREFIX: ""
        - name: Build and push Docker image to Docker Hub
          uses: docker/build-push-action@v2
          with:
            push: true
            file: docker/images/services.Dockerfile
            context: .
            tags: ${{ vars.DOCKER_REPOSITORY }}/xformer:${{ env.IMG_PREFIX }}${{ github.ref_name }}, ${{ vars.DOCKER_REPOSITORY }}/xformer:latest
        - name: Build and push Docker image to Quay.io
          uses: docker/build-push-action@v2
          with:
            push: true
            file: docker/images/services.Dockerfile
            context: .
            tags: quay.io/${{ vars.QUAY_REPOSITORY }}/xformer:${{ github.ref_name }}, ${{ vars.DOCKER_REPOSITORY }}/xformer:latest